{% extends "base.html" %}

{% block title %}Government Insights – ClearCouncil{% endblock %}

{% block plotly %}{# charts on this page are HTML-based, not Plotly #}{% endblock %}

{% block breadcrumb %}
<nav class="cc-breadcrumb" aria-label="Breadcrumb">
  <a href="{{ url_for('main.index') }}">Home</a>
  <span class="sep" aria-hidden="true">/</span>
  <span aria-current="page">Insights</span>
</nav>
{% endblock %}

{% block content %}
<div class="cc-fade-in">

  <!-- ── Hero / live stats ─────────────────────────────────────── -->
  <div class="cc-hero mb-4">
    <i class="fas fa-lightbulb fa-3x mb-3" aria-hidden="true" style="opacity:.8;"></i>
    <h1>Government Insights</h1>
    <p class="lead">
      Discover patterns, trends, and insights hidden in local government data.
    </p>
    <div class="cc-stats-grid mt-4" id="live-stats"
         style="max-width:700px;margin-left:auto;margin-right:auto;"></div>
  </div>

  <!-- ── Key insights grid ─────────────────────────────────────── -->
  <section aria-labelledby="insights-heading" class="mb-5">
    <h2 id="insights-heading" class="text-center mb-4" style="font-size:1.4rem;">
      <i class="fas fa-chart-line text-primary me-2" aria-hidden="true"></i>
      Key Discoveries About Your Local Government
    </h2>
    <div class="cc-features-grid cc-stagger" id="insights-grid"></div>
  </section>

  <!-- ── Leadership analysis ───────────────────────────────────── -->
  <div class="cc-card mb-5">
    <div class="cc-card-header">
      <i class="fas fa-crown text-warning" aria-hidden="true"></i>
      <span>Leadership Activity Analysis</span>
    </div>
    <div class="cc-card-body">
      <div class="row g-4">
        <div class="col-lg-8">
          <h5 class="mb-2">Most Active Representatives by Leadership Actions</h5>
          <p class="text-muted mb-3" style="font-size:.88rem;">
            Leadership activity is measured by motions made and seconds given.
            This shows which representatives take initiative in bringing forward legislation
            and supporting colleagues' proposals.
          </p>
          <div id="leadership-chart"></div>
        </div>
        <div class="col-lg-4">
          <div style="background:var(--cc-bg);border-radius:var(--cc-radius);padding:1.25rem;border:1px solid var(--cc-border);">
            <h6 class="text-primary mb-3">What This Tells Us</h6>
            <ul class="list-unstyled" style="font-size:.88rem;">
              <li class="mb-3">
                <i class="fas fa-check-circle text-success me-2" aria-hidden="true"></i>
                <strong>Initiative Takers:</strong> Representatives who frequently make motions
                are actively driving the legislative agenda.
              </li>
              <li class="mb-3">
                <i class="fas fa-check-circle text-success me-2" aria-hidden="true"></i>
                <strong>Team Players:</strong> Those giving seconds show collaboration
                and support for colleagues' ideas.
              </li>
              <li>
                <i class="fas fa-check-circle text-success me-2" aria-hidden="true"></i>
                <strong>Balanced Leadership:</strong> High activity in both areas indicates
                a well-rounded leadership style.
              </li>
            </ul>
            <hr style="border-color:var(--cc-border);">
            <p style="font-size:.82rem;color:var(--cc-text-muted);margin:0;">
              A "motion" is a formal proposal for action; a "second" is required support
              before the motion can be discussed and voted on.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Consensus & contentious ───────────────────────────────── -->
  <div class="row g-3 mb-5">
    <div class="col-lg-8">
      <div class="cc-card h-100">
        <div class="cc-card-header">
          <i class="fas fa-handshake text-success" aria-hidden="true"></i>
          <span>Consensus &amp; Collaboration</span>
        </div>
        <div class="cc-card-body" id="consensus-analysis">
          <div class="cc-skeleton cc-skeleton-lg" style="width:60%;margin:1rem auto;"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="cc-card h-100">
        <div class="cc-card-header">
          <i class="fas fa-exclamation-triangle text-warning" aria-hidden="true"></i>
          <span>Contentious Issues</span>
        </div>
        <div class="cc-card-body" id="contentious-analysis">
          <div class="cc-skeleton cc-skeleton-lg" style="width:50%;margin:1rem auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── District representation ───────────────────────────────── -->
  <div class="cc-card mb-5">
    <div class="cc-card-header">
      <i class="fas fa-map text-info" aria-hidden="true"></i>
      <span>District Representation Overview</span>
    </div>
    <div class="cc-card-body">
      <div class="row g-4">
        <div class="col-lg-6">
          <h5 class="mb-2">Geographic Distribution</h5>
          <p class="text-muted mb-3" style="font-size:.88rem;">
            Understanding how representation is distributed across districts
            and the activity levels in each area.
          </p>
          <div id="district-chart"></div>
        </div>
        <div class="col-lg-6">
          <h5 class="mb-3">What This Means</h5>
          <div class="d-flex flex-column gap-3">
            <div style="padding:1rem;border-left:3px solid var(--cc-info);background:var(--cc-bg);border-radius:0 var(--cc-radius-sm) var(--cc-radius-sm) 0;">
              <h6 class="text-primary mb-1">Equal Representation</h6>
              <p class="text-muted mb-0" style="font-size:.82rem;">
                Each district should have adequate representation to ensure
                all community voices are heard in government decisions.
              </p>
            </div>
            <div style="padding:1rem;border-left:3px solid var(--cc-info);background:var(--cc-bg);border-radius:0 var(--cc-radius-sm) var(--cc-radius-sm) 0;">
              <h6 class="text-primary mb-1">Activity Patterns</h6>
              <p class="text-muted mb-0" style="font-size:.82rem;">
                Differences in activity levels between districts can indicate
                varying approaches to governance or different community needs.
              </p>
            </div>
            <div style="padding:1rem;border-left:3px solid var(--cc-info);background:var(--cc-bg);border-radius:0 var(--cc-radius-sm) var(--cc-radius-sm) 0;">
              <h6 class="text-primary mb-1">At-Large vs District</h6>
              <p class="text-muted mb-0" style="font-size:.82rem;">
                At-Large representatives serve the entire jurisdiction,
                while district representatives focus on specific geographic areas.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Methodology ───────────────────────────────────────────── -->
  <div class="cc-card mb-5">
    <div class="cc-card-header">
      <i class="fas fa-info-circle text-primary" aria-hidden="true"></i>
      <span>How We Generate These Insights</span>
    </div>
    <div class="cc-card-body">
      <div class="cc-journey" style="margin:0 0 1.5rem;">
        <div class="cc-step">
          <div class="cc-step-num">1</div>
          <h5>Data Collection</h5>
          <p>We automatically process official council meeting documents, extracting voting records, motions, and representative actions.</p>
        </div>
        <div class="cc-step">
          <div class="cc-step-num">2</div>
          <h5>Pattern Analysis</h5>
          <p>Algorithms identify patterns in voting behavior, leadership activity, and collaboration between representatives.</p>
        </div>
        <div class="cc-step">
          <div class="cc-step-num">3</div>
          <h5>Insight Generation</h5>
          <p>Complex data patterns are translated into meaningful insights that help citizens understand their local government.</p>
        </div>
      </div>
      <div style="background:var(--cc-primary-light);border-radius:var(--cc-radius-sm);padding:1rem 1.25rem;border-left:3px solid var(--cc-primary);">
        <strong><i class="fas fa-shield-alt me-2" aria-hidden="true"></i>Data Transparency &amp; Accuracy</strong>
        <p class="mb-0 mt-1" style="font-size:.88rem;">
          All insights are generated from publicly available government documents.
          We maintain complete transparency about our data sources and methodology.
          <a href="{{ url_for('main.data_transparency') }}" style="color:var(--cc-primary);">
            View our data transparency report →
          </a>
        </p>
      </div>
    </div>
  </div>

  <!-- ── CTA ───────────────────────────────────────────────────── -->
  <div class="cc-hero" style="background:linear-gradient(135deg,var(--cc-bg) 0%,var(--cc-border) 100%);color:var(--cc-text);">
    <h4>Dive Deeper Into the Data</h4>
    <p style="color:var(--cc-text-muted);margin-bottom:1.5rem;">
      These insights are just the beginning. Explore detailed representative profiles,
      compare voting patterns, and discover trends that matter to your community.
    </p>
    <div class="d-flex flex-wrap justify-content-center gap-2">
      <a href="{{ url_for('main.index') }}#councils" class="cc-btn cc-btn-primary cc-btn-lg">
        <i class="fas fa-search" aria-hidden="true"></i>Explore Council Data
      </a>
      <a href="{{ url_for('main.data_transparency') }}" class="cc-btn cc-btn-outline cc-btn-lg">
        <i class="fas fa-chart-bar" aria-hidden="true"></i>View All Analytics
      </a>
    </div>
  </div>

</div><!-- /.cc-fade-in -->
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadLiveStats();
    loadInsightsGrid();
    loadLeadershipChart();
    loadConsensusAnalysis();
    loadContentiousAnalysis();
    loadDistrictChart();
});

function loadLiveStats() {
    fetch('/api/insights/summary')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const statsHtml = `
                    <div class="cc-stat" style="background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.2);">
                        <span class="cc-stat-number" style="color:#fff;" data-value="${data.stats.total_representatives}">0</span>
                        <span class="cc-stat-label" style="color:rgba(255,255,255,0.7);">Representatives</span>
                    </div>
                    <div class="cc-stat" style="background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.2);">
                        <span class="cc-stat-number" style="color:#fff;" data-value="${data.stats.total_votes}">0</span>
                        <span class="cc-stat-label" style="color:rgba(255,255,255,0.7);">Votes Tracked</span>
                    </div>
                    <div class="cc-stat" style="background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.2);">
                        <span class="cc-stat-number" style="color:#fff;" data-value="${data.stats.total_motions}">0</span>
                        <span class="cc-stat-label" style="color:rgba(255,255,255,0.7);">Motions Made</span>
                    </div>
                    <div class="cc-stat" style="background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.2);">
                        <span class="cc-stat-number" style="color:#fff;" data-value="${Array.isArray(data.stats.districts) ? data.stats.districts.length : (data.stats.districts || 0)}">0</span>
                        <span class="cc-stat-label" style="color:rgba(255,255,255,0.7);">Districts</span>
                    </div>
                `;
                document.getElementById('live-stats').innerHTML = statsHtml;
                animateStatNumbers();
            }
        })
        .catch(error => console.error('Error loading stats:', error));
}

function loadInsightsGrid() {
    fetch('/api/insights/patterns')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const INSIGHT_STYLES = [
                    { colorVar: '--cc-primary',  icon: 'crown'         },
                    { colorVar: '--cc-success',  icon: 'handshake'     },
                    { colorVar: '--cc-warning',  icon: 'balance-scale' },
                    { colorVar: '--cc-info',     icon: 'chart-line'    },
                    { colorVar: '--cc-accent',   icon: 'users'         },
                    { colorVar: '--cc-danger',   icon: 'lightbulb'     },
                ];

                let gridHtml = '';
                data.patterns.slice(0, 6).forEach((pattern, index) => {
                    const style = INSIGHT_STYLES[index % INSIGHT_STYLES.length];
                    gridHtml += `
                        <div class="cc-card cc-feature-card">
                            <div class="cc-card-body text-center">
                                <div style="width:56px;height:56px;border-radius:50%;background:var(${style.colorVar});
                                            display:flex;align-items:center;justify-content:center;
                                            margin:0 auto 1rem;color:#fff;font-size:1.4rem;">
                                    <i class="fas fa-${style.icon}" aria-hidden="true"></i>
                                </div>
                                <h5 style="font-size:.95rem;">${pattern.title}</h5>
                                <div style="font-size:2rem;font-weight:800;color:var(${style.colorVar});line-height:1;margin:.5rem 0;">
                                    ${formatValue(pattern.value, pattern.type)}
                                </div>
                                <p class="text-muted" style="font-size:.82rem;margin:0;">${pattern.description}</p>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('insights-grid').innerHTML = gridHtml;
            }
        })
        .catch(error => console.error('Error loading insights:', error));
}

function loadLeadershipChart() {
    fetch('/api/insights/leadership')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let chartHtml = '';
                data.representatives.slice(0, 8).forEach(rep => {
                    const maxMotions = Math.max(...data.representatives.map(r => r.motions));
                    const maxSeconds = Math.max(...data.representatives.map(r => r.seconds));
                    const motionWidth = maxMotions > 0 ? (rep.motions / maxMotions) * 100 : 0;
                    const secondWidth = maxSeconds > 0 ? (rep.seconds / maxSeconds) * 100 : 0;

                    chartHtml += `
                        <div style="margin-bottom:1rem;">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div>
                                    <strong style="font-size:.88rem;">${rep.name}</strong>
                                    <span class="text-muted" style="font-size:.78rem;margin-left:.5rem;">${rep.district}</span>
                                </div>
                                <small class="text-muted">Total: ${rep.total}</small>
                            </div>
                            <div style="background:var(--cc-border);border-radius:999px;height:16px;margin-bottom:4px;overflow:hidden;">
                                <div style="background:var(--cc-primary);border-radius:999px;height:16px;width:${motionWidth}%;
                                            display:flex;align-items:center;padding-left:6px;font-size:.65rem;color:#fff;font-weight:600;white-space:nowrap;">
                                    ${rep.motions > 0 ? rep.motions + ' motions' : ''}
                                </div>
                            </div>
                            <div style="background:var(--cc-border);border-radius:999px;height:16px;overflow:hidden;">
                                <div style="background:var(--cc-success);border-radius:999px;height:16px;width:${secondWidth}%;
                                            display:flex;align-items:center;padding-left:6px;font-size:.65rem;color:#fff;font-weight:600;white-space:nowrap;">
                                    ${rep.seconds > 0 ? rep.seconds + ' seconds' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('leadership-chart').innerHTML = chartHtml;
            }
        })
        .catch(error => console.error('Error loading leadership chart:', error));
}

function loadConsensusAnalysis() {
    fetch('/api/insights/patterns')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const pattern = data.patterns.find(p => p.type === 'unanimous_rate');
                if (pattern) {
                    document.getElementById('consensus-analysis').innerHTML = `
                        <div class="text-center mb-3">
                            <div style="font-size:3rem;font-weight:800;color:var(--cc-success);line-height:1;">${pattern.value.toFixed(1)}%</div>
                            <div class="text-muted" style="font-size:.88rem;">Unanimous Decisions</div>
                        </div>
                        <p class="text-muted" style="font-size:.88rem;">${pattern.description}</p>
                        <ul class="list-unstyled" style="font-size:.85rem;">
                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Strong collaboration</li>
                            <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Effective compromise</li>
                            <li><i class="fas fa-check text-success me-2"></i>Shared priorities</li>
                        </ul>
                    `;
                }
            }
        })
        .catch(error => console.error('Error loading consensus analysis:', error));
}

function loadContentiousAnalysis() {
    fetch('/api/insights/patterns')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const pattern = data.patterns.find(p => p.type === 'close_votes');
                if (pattern) {
                    document.getElementById('contentious-analysis').innerHTML = `
                        <div class="text-center mb-3">
                            <div style="font-size:3rem;font-weight:800;color:var(--cc-warning);line-height:1;">${pattern.count}</div>
                            <div class="text-muted" style="font-size:.88rem;">Close Votes</div>
                        </div>
                        <p class="text-muted" style="font-size:.88rem;">${pattern.description}</p>
                        <ul class="list-unstyled" style="font-size:.85rem;">
                            <li class="mb-1"><i class="fas fa-exclamation text-warning me-2"></i>Complex issues</li>
                            <li class="mb-1"><i class="fas fa-exclamation text-warning me-2"></i>Diverse viewpoints</li>
                            <li><i class="fas fa-exclamation text-warning me-2"></i>Careful deliberation</li>
                        </ul>
                    `;
                }
            }
        })
        .catch(error => console.error('Error loading contentious analysis:', error));
}

function loadDistrictChart() {
    fetch('/api/insights/districts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let chartHtml = '';
                Object.entries(data.district_counts).forEach(([district, count]) => {
                    const percentage = data.total_representatives > 0
                        ? (count / data.total_representatives) * 100 : 0;
                    chartHtml += `
                        <div style="margin-bottom:.75rem;">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong style="font-size:.88rem;">${district}</strong>
                                <span class="cc-badge cc-badge-info">${count} rep${count !== 1 ? 's' : ''}</span>
                            </div>
                            <div style="background:var(--cc-border);border-radius:999px;height:8px;overflow:hidden;">
                                <div style="background:var(--cc-info);border-radius:999px;height:8px;width:${percentage}%;"></div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('district-chart').innerHTML = chartHtml;
            }
        })
        .catch(error => console.error('Error loading district chart:', error));
}

function formatValue(value, type) {
    if (type === 'unanimous_rate' || type === 'approval_rate' || type === 'close_votes') {
        return `${typeof value === 'number' ? value.toFixed(1) : value}%`;
    }
    return typeof value === 'number' ? value.toLocaleString() : value;
}

function animateStatNumbers() {
    document.querySelectorAll('.cc-stat-number[data-value]').forEach(stat => {
        const finalValue = parseInt(stat.getAttribute('data-value')) || 0;
        animateNumber(stat, 0, finalValue, 1800);
    });
}

function animateNumber(element, start, end, duration) {
    const startTime = performance.now();
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        element.textContent = Math.floor(start + (end - start) * easeOutCubic(progress)).toLocaleString();
        if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
}

function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }
</script>
{% endblock %}