<!DOCTYPE html>
<html lang="en" data-theme="light" x-data="ccApp()" :data-theme="darkMode ? 'dark' : 'light'">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ClearCouncil - Local Government Transparency{% endblock %}</title>
    <meta name="description" content="ClearCouncil makes local government transparent – explore representative voting records, compare officials, and understand your local council.">

    <!-- Bootstrap CSS (layout utilities) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- ClearCouncil custom stylesheet (lightweight, easily modified) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/clearcouncil.css') }}">

    <!-- HTMX – lightweight HTML-over-the-wire library (14 KB) -->
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/htmx.min.js" defer></script>

    <!-- Alpine.js – minimal reactivity for dark mode, menus (15 KB) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Accessibility: skip to main content -->
    <a class="skip-link" href="#main-content">Skip to main content</a>

    <!-- ── Top navigation ───────────────────────────────────────── -->
    <nav class="cc-navbar" role="navigation" aria-label="Main navigation">
        <div class="container-fluid d-flex align-items-center gap-3">

            <!-- Brand -->
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="fas fa-landmark" aria-hidden="true"></i>
                <span>ClearCouncil</span>
            </a>

            <!-- Desktop nav links (hidden on mobile) -->
            <ul class="navbar-nav flex-row gap-1 me-auto desktop-nav" role="list">
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'main.index' %}active{% endif %}"
                       href="{{ url_for('main.index') }}">
                        <i class="fas fa-home me-1" aria-hidden="true"></i>Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'main.insights' %}active{% endif %}"
                       href="{{ url_for('main.insights') }}">
                        <i class="fas fa-lightbulb me-1" aria-hidden="true"></i>Insights
                    </a>
                </li>
                {% if councils %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="councilDropdown"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-building me-1" aria-hidden="true"></i>Councils
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="councilDropdown">
                        {% for council_id in councils %}
                        <li>
                            <a class="dropdown-item" href="{{ url_for('main.council_overview', council_id=council_id) }}">
                                {{ council_id|replace('_', ' ')|title }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'main.data_transparency' %}active{% endif %}"
                       href="{{ url_for('main.data_transparency') }}">
                        <i class="fas fa-shield-alt me-1" aria-hidden="true"></i>Transparency
                    </a>
                </li>
            </ul>

            <!-- Right-side controls -->
            <div class="d-flex align-items-center gap-2 ms-auto">
                <!-- Global search (desktop) -->
                <form class="d-none d-md-flex align-items-center gap-1"
                      action="{{ url_for('main.search') }}" method="get"
                      role="search" aria-label="Search council documents">
                    {% if councils %}
                    <input type="hidden" name="council_id" value="{{ councils[0] }}">
                    {% endif %}
                    <input type="search" name="q" placeholder="Search documents…"
                           class="cc-input" style="width:180px;padding:0.3rem 0.75rem;font-size:0.85rem;"
                           aria-label="Search documents">
                    <button type="submit" class="cc-btn cc-btn-primary cc-btn-sm" aria-label="Submit search">
                        <i class="fas fa-search" aria-hidden="true"></i>
                    </button>
                </form>

                <!-- Dark mode toggle -->
                <button class="cc-darkmode-btn" @click="toggleDark()"
                        :aria-label="darkMode ? 'Switch to light mode' : 'Switch to dark mode'"
                        :title="darkMode ? 'Light mode' : 'Dark mode'">
                    <i :class="darkMode ? 'fas fa-sun' : 'fas fa-moon'" aria-hidden="true"></i>
                </button>

                <!-- Upload quick link -->
                <a href="{{ url_for('main.upload_documents') }}"
                   class="cc-btn cc-btn-outline cc-btn-sm d-none d-lg-inline-flex"
                   style="border-color:rgba(255,255,255,0.3);color:#fff;"
                   aria-label="Upload council documents">
                    <i class="fas fa-upload" aria-hidden="true"></i>Upload
                </a>
            </div>

        </div>
    </nav>

    <!-- ── Page wrapper ─────────────────────────────────────────── -->
    <div class="page-wrapper">
        <main class="page-content container-fluid py-4" id="main-content">

            <!-- HTMX global loading bar -->
            <div id="cc-loading-bar" class="htmx-indicator"
                 style="position:fixed;top:3.5rem;left:0;right:0;height:3px;background:var(--cc-primary);z-index:2000;animation:cc-shimmer 1.4s infinite;background-size:200% 100%;"
                 aria-hidden="true"></div>

            <!-- Breadcrumb (optional, set by child template) -->
            {% block breadcrumb %}{% endblock %}

            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="row mb-3">
                <div class="col-12">
                    {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-circle' if category == 'error' else 'info-circle' }} me-2" aria-hidden="true"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endwith %}

            <!-- Page content -->
            {% block content %}{% endblock %}

        </main>

        <!-- ── Footer ─────────────────────────────────────────── -->
        <footer style="background:var(--cc-secondary);color:#fff;padding:2rem 0;margin-top:3rem;">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-1 fw-bold"><i class="fas fa-landmark me-2" aria-hidden="true"></i>ClearCouncil</p>
                        <p class="mb-0" style="font-size:0.85rem;opacity:0.7;">
                            Making local government transparent and accessible to everyone.
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end mt-3 mt-md-0" style="font-size:0.8rem;opacity:0.6;">
                        v{{ app_version }} &middot;
                        <a href="{{ url_for('main.data_transparency') }}" style="color:rgba(255,255,255,0.7);">Data Sources</a> &middot;
                        <a href="{{ url_for('main.settings') }}" style="color:rgba(255,255,255,0.7);">Settings</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ── Mobile bottom navigation ────────────────────────────── -->
    <nav class="cc-bottom-nav" role="navigation" aria-label="Mobile navigation">
        <a href="{{ url_for('main.index') }}"
           class="{{ 'active' if request.endpoint == 'main.index' else '' }}"
           aria-label="Home">
            <i class="fas fa-home" aria-hidden="true"></i>Home
        </a>
        {% if councils %}
        <a href="{{ url_for('main.council_overview', council_id=councils[0]) }}"
           class="{{ 'active' if request.endpoint == 'main.council_overview' else '' }}"
           aria-label="Council">
            <i class="fas fa-building" aria-hidden="true"></i>Council
        </a>
        {% endif %}
        <a href="{{ url_for('main.insights') }}"
           class="{{ 'active' if request.endpoint == 'main.insights' else '' }}"
           aria-label="Insights">
            <i class="fas fa-lightbulb" aria-hidden="true"></i>Insights
        </a>
        <a href="{{ url_for('main.search') if councils else '#' }}"
           class="{{ 'active' if request.endpoint == 'main.search' else '' }}"
           aria-label="Search">
            <i class="fas fa-search" aria-hidden="true"></i>Search
        </a>
        <a href="{{ url_for('main.data_transparency') }}"
           class="{{ 'active' if request.endpoint == 'main.data_transparency' else '' }}"
           aria-label="Transparency">
            <i class="fas fa-shield-alt" aria-hidden="true"></i>Data
        </a>
    </nav>

    <!-- Bootstrap JS bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Plotly.js (deferred – only loaded when a chart page needs it) -->
    {% block plotly %}{% endblock %}

    <!-- Alpine.js app component -->
    <script>
    function ccApp() {
        return {
            darkMode: localStorage.getItem('cc-dark') === 'true',
            init() {
                // Apply saved preference immediately
                document.documentElement.setAttribute(
                    'data-theme', this.darkMode ? 'dark' : 'light'
                );
            },
            toggleDark() {
                this.darkMode = !this.darkMode;
                localStorage.setItem('cc-dark', this.darkMode);
                document.documentElement.setAttribute(
                    'data-theme', this.darkMode ? 'dark' : 'light'
                );
            }
        };
    }

    // Utility helpers (available globally)
    function formatDate(dateString) {
        const d = new Date(dateString);
        return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function updateURL(params) {
        const url = new URL(window.location);
        for (const [k, v] of Object.entries(params)) {
            v ? url.searchParams.set(k, v) : url.searchParams.delete(k);
        }
        window.history.replaceState({}, '', url);
    }

    // Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            new bootstrap.Tooltip(el);
        });
    });

    // HTMX: attach loading bar indicator to all requests
    document.addEventListener('htmx:configRequest', () => {
        document.getElementById('cc-loading-bar')?.classList.add('htmx-request');
    });
    document.addEventListener('htmx:afterRequest', () => {
        document.getElementById('cc-loading-bar')?.classList.remove('htmx-request');
    });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>