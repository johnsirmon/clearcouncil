{% extends "base.html" %}

{% block title %}Compare Representatives – ClearCouncil{% endblock %}

{% block plotly %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" defer></script>
{% endblock %}

{% block breadcrumb %}
<nav class="cc-breadcrumb" aria-label="Breadcrumb">
  <a href="{{ url_for('main.index') }}">Home</a>
  <span class="sep" aria-hidden="true">/</span>
  {% if council %}
  <a href="{{ url_for('main.council_overview', council_id=council.identifier) }}">{{ council.name }}</a>
  <span class="sep" aria-hidden="true">/</span>
  {% endif %}
  <span aria-current="page">Compare</span>
</nav>
{% endblock %}

{% block content %}
<div class="cc-fade-in">

  <!-- ── Page header ───────────────────────────────────────────── -->
  <div class="cc-card mb-4">
    <div class="cc-card-body">
      <h1 style="font-size:1.75rem;margin-bottom:0.25rem;">
        <i class="fas fa-balance-scale text-primary me-2" aria-hidden="true"></i>
        Compare Representatives
      </h1>
      <p class="text-muted mb-0" style="font-size:.92rem;">
        Compare voting patterns and activity levels between different representatives.
      </p>
    </div>
  </div>

  <!-- ── Selection controls ────────────────────────────────────── -->
  <div class="cc-card mb-4">
    <div class="cc-card-header">
      <i class="fas fa-users text-primary" aria-hidden="true"></i>
      <span>Select Representatives to Compare</span>
    </div>
    <div class="cc-card-body">
      <form id="comparisonForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="representativeSelect"
                   style="font-size:.85rem;font-weight:600;color:var(--cc-text-muted);">
              Choose Representatives (2–4)
            </label>
            <select multiple class="cc-input mt-1" id="representativeSelect" name="representatives"
                    style="height:150px;" required aria-label="Select representatives">
              {% for rep in representatives %}
              <option value="{{ rep.id }}" {% if rep.id in selected_rep_ids %}selected{% endif %}>
                {{ rep.name }} ({{ rep.district }}) – {{ rep.total_votes }} votes
              </option>
              {% endfor %}
            </select>
            <p style="font-size:.78rem;color:var(--cc-text-muted);margin-top:.35rem;margin-bottom:0;">
              Hold Ctrl/Cmd to select multiple representatives
            </p>
          </div>
          <div class="col-md-6">
            <div class="row g-2">
              <div class="col-6">
                <label for="startDate" style="font-size:.85rem;font-weight:600;color:var(--cc-text-muted);">Start Date</label>
                <input type="date" class="cc-input mt-1" id="startDate" name="start_date"
                       min="{{ min_date }}" max="{{ max_date }}">
              </div>
              <div class="col-6">
                <label for="endDate" style="font-size:.85rem;font-weight:600;color:var(--cc-text-muted);">End Date</label>
                <input type="date" class="cc-input mt-1" id="endDate" name="end_date"
                       min="{{ min_date }}" max="{{ max_date }}">
              </div>
              <div class="col-12">
                <label for="quickFilter" style="font-size:.85rem;font-weight:600;color:var(--cc-text-muted);">Quick Filter</label>
                <select class="cc-input mt-1" id="quickFilter" aria-label="Quick date filter">
                  <option value="">All Time</option>
                  <option value="last_month">Last Month</option>
                  <option value="last_3_months">Last 3 Months</option>
                  <option value="last_6_months">Last 6 Months</option>
                  <option value="last_year">Last Year</option>
                  <option value="this_year">This Year</option>
                </select>
              </div>
              <div class="col-12 d-flex gap-2 align-items-end mt-1">
                <button type="submit" class="cc-btn cc-btn-primary cc-btn-sm">
                  <i class="fas fa-chart-bar" aria-hidden="true"></i>Compare
                </button>
                <button type="button" class="cc-btn cc-btn-outline cc-btn-sm" onclick="clearComparison()">
                  <i class="fas fa-times" aria-hidden="true"></i>Clear
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ── Quick stats ───────────────────────────────────────────── -->
  {% if selected_rep_ids|length >= 2 %}
  <div class="cc-card mb-4" id="quickStatsRow">
    <div class="cc-card-header">
      <i class="fas fa-tachometer-alt text-primary" aria-hidden="true"></i>
      <span>Quick Comparison</span>
    </div>
    <div class="cc-card-body">
      <div class="cc-stats-grid" id="quickStatsContainer"></div>
    </div>
  </div>
  {% endif %}

  <!-- ── Comparison chart ──────────────────────────────────────── -->
  {% if comparison_chart %}
  <div class="cc-card mb-4">
    <div class="cc-card-header">
      <i class="fas fa-chart-bar text-primary" aria-hidden="true"></i>
      <span>Detailed Comparison</span>
    </div>
    <div class="cc-card-body">
      <div id="comparisonChart" style="min-height:320px;"></div>
    </div>
  </div>
  {% endif %}

  <!-- ── Side-by-side details (shown after compare) ────────────── -->
  <div class="cc-card mb-4" id="detailsRow" style="display:none;">
    <div class="cc-card-header">
      <i class="fas fa-list text-primary" aria-hidden="true"></i>
      <span>Side-by-Side Details</span>
    </div>
    <div class="cc-card-body">
      <div class="row g-3" id="detailsContainer"></div>
    </div>
  </div>

  <!-- ── Analysis insights ─────────────────────────────────────── -->
  <div class="cc-card mb-4" id="insightsRow" style="display:none;">
    <div class="cc-card-header">
      <i class="fas fa-lightbulb text-warning" aria-hidden="true"></i>
      <span>Analysis Insights</span>
    </div>
    <div class="cc-card-body" id="insightsContainer"></div>
  </div>

  <!-- ── Individual profiles ───────────────────────────────────── -->
  {% if selected_rep_ids|length >= 2 %}
  <div class="cc-card mb-4">
    <div class="cc-card-header">
      <i class="fas fa-user-friends text-primary" aria-hidden="true"></i>
      <span>Individual Representative Profiles</span>
    </div>
    <div class="cc-card-body">
      <div class="row g-3" id="representativeProfiles"></div>
    </div>
  </div>
  {% endif %}

  <!-- ── Export options ────────────────────────────────────────── -->
  {% if selected_rep_ids|length >= 2 %}
  <div class="cc-card mb-4">
    <div class="cc-card-header">
      <i class="fas fa-download text-primary" aria-hidden="true"></i>
      <span>Export Comparison</span>
    </div>
    <div class="cc-card-body d-flex flex-wrap gap-2">
      <button class="cc-btn cc-btn-outline cc-btn-sm" onclick="exportComparison('pdf')">
        <i class="fas fa-file-pdf" aria-hidden="true"></i>PDF
      </button>
      <button class="cc-btn cc-btn-outline cc-btn-sm" onclick="exportComparison('csv')">
        <i class="fas fa-file-csv" aria-hidden="true"></i>CSV
      </button>
      <button class="cc-btn cc-btn-outline cc-btn-sm" onclick="exportComparison('html')">
        <i class="fas fa-file-code" aria-hidden="true"></i>HTML
      </button>
      <button class="cc-btn cc-btn-outline cc-btn-sm" onclick="shareComparison()">
        <i class="fas fa-share" aria-hidden="true"></i>Share Link
      </button>
    </div>
  </div>
  {% endif %}

  <!-- ── Help ──────────────────────────────────────────────────── -->
  <div class="cc-card">
    <div class="cc-card-header">
      <i class="fas fa-question-circle text-primary" aria-hidden="true"></i>
      <span>How to Use This Tool</span>
    </div>
    <div class="cc-card-body">
      <div class="cc-journey" style="margin:0;">
        <div class="cc-step">
          <div class="cc-step-num">1</div>
          <h5>Select Representatives</h5>
          <p>Choose 2–4 representatives from the list above.</p>
        </div>
        <div class="cc-step">
          <div class="cc-step-num">2</div>
          <h5>Set Time Period</h5>
          <p>Use date filters or quick presets to narrow results.</p>
        </div>
        <div class="cc-step">
          <div class="cc-step-num">3</div>
          <h5>Analyze Results</h5>
          <p>Review charts and insights to understand voting differences.</p>
        </div>
        <div class="cc-step">
          <div class="cc-step-num">4</div>
          <h5>Export &amp; Share</h5>
          <p>Download or share a direct link to this comparison.</p>
        </div>
      </div>
    </div>
  </div>

</div><!-- /.cc-fade-in -->
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load initial comparison if representatives are selected
    {% if comparison_chart %}
    loadComparisonChart();
    {% endif %}
    
    // Setup form handler
    document.getElementById('comparisonForm').addEventListener('submit', function(e) {
        e.preventDefault();
        performComparison();
    });
    
    // Quick filter handler
    document.getElementById('quickFilter').addEventListener('change', function() {
        applyQuickFilter(this.value);
    });
    
    // Load initial data if representatives are selected
    {% if selected_rep_ids|length >= 2 %}
    loadInitialData();
    {% endif %}
});

function loadComparisonChart() {
    const chartData = JSON.parse('{{ comparison_chart|safe }}');
    Plotly.newPlot('comparisonChart', chartData.data, chartData.layout, {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
    });
}

function performComparison() {
    const selectedReps = Array.from(document.getElementById('representativeSelect').selectedOptions)
        .map(option => option.value);
    
    if (selectedReps.length < 2) {
        alert('Please select at least 2 representatives to compare');
        return;
    }
    
    if (selectedReps.length > 4) {
        alert('Please select no more than 4 representatives for optimal comparison');
        return;
    }
    
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    // Show loading
    showLoading('comparisonChart');
    
    // Build query parameters
    const params = new URLSearchParams();
    params.append('council_id', '{{ council.identifier }}');
    selectedReps.forEach(rep => params.append('representatives', rep));
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    // Fetch comparison data
    fetch(`/api/comparison-chart?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const chartData = JSON.parse(data.chart);
                Plotly.newPlot('comparisonChart', chartData.data, chartData.layout, {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false
                });
                
                // Update URL
                updateURL({
                    council_id: '{{ council.identifier }}',
                    representatives: selectedReps,
                    start_date: startDate,
                    end_date: endDate
                });
                
                // Load additional data
                loadQuickStats(selectedReps, startDate, endDate);
                loadDetailedComparison(selectedReps, startDate, endDate);
                loadInsights(selectedReps, startDate, endDate);
                
                // Show additional sections
                document.getElementById('detailsRow').style.display = 'block';
                document.getElementById('insightsRow').style.display = 'block';
                
            } else {
                alert('Error loading comparison: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error performing comparison:', error);
            alert('Error performing comparison');
        });
}

function loadInitialData() {
    const selectedReps = {{ selected_rep_ids|tojson }};
    loadQuickStats(selectedReps);
    loadRepresentativeProfiles(selectedReps);
}

function loadQuickStats(repIds, startDate = null, endDate = null) {
    const params = new URLSearchParams();
    params.append('council_id', '{{ council.identifier }}');
    repIds.forEach(id => params.append('representatives', id));
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    fetch(`/api/quick-stats?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateQuickStats(data.stats);
            }
        })
        .catch(error => {
            console.error('Error loading quick stats:', error);
        });
}

function updateQuickStats(stats) {
    const container = document.getElementById('quickStatsContainer');
    container.innerHTML = '';

    stats.forEach(stat => {
        const col = document.createElement('div');
        col.className = 'cc-stat';
        col.innerHTML = `
            <span class="cc-stat-number">${stat.total_votes}</span>
            <span class="cc-stat-label">${stat.name}</span>
            <div style="font-size:.75rem;color:var(--cc-text-muted);margin-top:.25rem;">
                <span style="color:var(--cc-success);">${stat.motions_made} motions</span>
                &middot;
                <span style="color:var(--cc-info);">${stat.seconds_given} seconds</span>
            </div>
        `;
        container.appendChild(col);
    });
}

function loadDetailedComparison(repIds, startDate = null, endDate = null) {
    const params = new URLSearchParams();
    params.append('council_id', '{{ council.identifier }}');
    repIds.forEach(id => params.append('representatives', id));
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    fetch(`/api/detailed-comparison?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDetailedComparison(data.details);
            }
        })
        .catch(error => {
            console.error('Error loading detailed comparison:', error);
        });
}

function updateDetailedComparison(details) {
    const container = document.getElementById('detailsContainer');
    container.innerHTML = '';

    const ACTIVITY_STYLE = {
        'High':   'cc-badge-success',
        'Medium': 'cc-badge-warning',
    };

    details.forEach(detail => {
        const col = document.createElement('div');
        col.className = 'col-md-6';
        const actClass = ACTIVITY_STYLE[detail.activity_level] || 'cc-badge-primary';
        col.innerHTML = `
            <div class="cc-card h-100">
                <div class="cc-card-header">
                    <span style="font-weight:700;">${detail.name}</span>
                    <span style="font-size:.8rem;color:var(--cc-text-muted);margin-left:.5rem;">${detail.district}</span>
                </div>
                <div class="cc-card-body">
                    <div class="d-flex flex-wrap gap-3 mb-3">
                        <div>
                            <div style="font-size:.78rem;color:var(--cc-text-muted);margin-bottom:.2rem;">Activity Level</div>
                            <span class="cc-badge ${actClass}">${detail.activity_level}</span>
                        </div>
                        <div>
                            <div style="font-size:.78rem;color:var(--cc-text-muted);margin-bottom:.2rem;">Focus Areas</div>
                            <small>${detail.focus_areas.join(', ')}</small>
                        </div>
                    </div>
                    <div>
                        <div style="font-size:.78rem;color:var(--cc-text-muted);margin-bottom:.3rem;">Approval Rate</div>
                        <div style="background:var(--cc-border);border-radius:999px;height:8px;">
                            <div style="background:var(--cc-success);border-radius:999px;height:8px;width:${detail.approval_rate}%;"></div>
                        </div>
                        <small style="color:var(--cc-text-muted);">${detail.approval_rate}%</small>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(col);
    });
}

function loadInsights(repIds, startDate = null, endDate = null) {
    const params = new URLSearchParams();
    params.append('council_id', '{{ council.identifier }}');
    repIds.forEach(id => params.append('representatives', id));
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    fetch(`/api/comparison-insights?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateInsights(data.insights);
            }
        })
        .catch(error => {
            console.error('Error loading insights:', error);
        });
}

function updateInsights(insights) {
    const container = document.getElementById('insightsContainer');
    container.innerHTML = '';

    const INSIGHT_TYPE = {
        positive: { borderColor: 'var(--cc-success)', icon: 'check-circle'        },
        negative: { borderColor: 'var(--cc-warning)', icon: 'exclamation-triangle' },
        neutral:  { borderColor: 'var(--cc-info)',    icon: 'info-circle'          },
    };

    insights.forEach(insight => {
        const { borderColor, icon } = INSIGHT_TYPE[insight.type] || INSIGHT_TYPE.neutral;
        const div = document.createElement('div');
        div.style.cssText = `padding:.75rem 1rem;border-left:3px solid ${borderColor};margin-bottom:.75rem;`;
        div.innerHTML = `
            <i class="fas fa-${icon} me-2" style="color:${borderColor};"></i>
            <strong>${insight.title}:</strong> ${insight.description}
        `;
        container.appendChild(div);
    });
}

function loadRepresentativeProfiles(repIds) {
    const container = document.getElementById('representativeProfiles');
    container.innerHTML = '';
    
    repIds.forEach(repId => {
        fetch(`/api/representative/${repId}/profile`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const profile = data.profile;
                    const col = document.createElement('div');
                    col.className = 'col-md-4 mb-3';
                    col.innerHTML = `
                        <div class="cc-rep-card" style="display:block;">
                            <div class="name">${profile.name}</div>
                            <div class="district">
                                <i class="fas fa-map-marker-alt me-1" aria-hidden="true"></i>${profile.district}
                            </div>
                            <div style="font-size:.78rem;color:var(--cc-text-muted);margin:.3rem 0 .6rem;">
                                Active since ${profile.first_seen}
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="/representative/${repId}" class="cc-btn cc-btn-outline cc-btn-sm">View Details</a>
                                <span class="cc-badge cc-badge-primary">${profile.total_votes} votes</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                }
            })
            .catch(error => {
                console.error('Error loading representative profile:', error);
            });
    });
}

function applyQuickFilter(period) {
    const today = new Date();
    let startDate = '';
    let endDate = today.toISOString().split('T')[0];
    
    switch(period) {
        case 'last_month':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate()).toISOString().split('T')[0];
            break;
        case 'last_3_months':
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate()).toISOString().split('T')[0];
            break;
        case 'last_6_months':
            startDate = new Date(today.getFullYear(), today.getMonth() - 6, today.getDate()).toISOString().split('T')[0];
            break;
        case 'last_year':
            startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate()).toISOString().split('T')[0];
            break;
        case 'this_year':
            startDate = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
            break;
        default:
            startDate = '';
            endDate = '';
    }
    
    document.getElementById('startDate').value = startDate;
    document.getElementById('endDate').value = endDate;
}

function clearComparison() {
    document.getElementById('representativeSelect').selectedIndex = -1;
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('quickFilter').value = '';
    
    // Hide additional sections
    document.getElementById('detailsRow').style.display = 'none';
    document.getElementById('insightsRow').style.display = 'none';
    
    // Clear chart
    document.getElementById('comparisonChart').innerHTML = '';
}

function exportComparison(format) {
    const selectedReps = Array.from(document.getElementById('representativeSelect').selectedOptions)
        .map(option => option.value);
    
    if (selectedReps.length < 2) {
        alert('Please select representatives to compare first');
        return;
    }
    
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const params = new URLSearchParams();
    params.append('council_id', '{{ council.identifier }}');
    selectedReps.forEach(rep => params.append('representatives', rep));
    params.append('format', format);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    window.open(`/api/export-comparison?${params.toString()}`, '_blank');
}

function shareComparison() {
    const selectedReps = Array.from(document.getElementById('representativeSelect').selectedOptions)
        .map(option => option.value);
    
    if (selectedReps.length < 2) {
        alert('Please select representatives to compare first');
        return;
    }
    
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const params = new URLSearchParams();
    params.append('council_id', '{{ council.identifier }}');
    selectedReps.forEach(rep => params.append('representatives', rep));
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    
    const shareUrl = `${window.location.origin}/compare?${params.toString()}`;
    
    navigator.clipboard.writeText(shareUrl).then(() => {
        alert('Comparison link copied to clipboard!');
    }).catch(() => {
        prompt('Copy this link to share the comparison:', shareUrl);
    });
}
</script>
{% endblock %}